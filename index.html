<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UppyMon | VPS Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        [v-cloak] { display: none; }
        .status-up { color: #10b981; background-color: #d1fae5; }
        .status-down { color: #ef4444; background-color: #fee2e2; }
        .status-unknown { color: #6b7280; background-color: #f3f4f6; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">
    <div id="app" v-cloak class="min-h-screen">
        
        <!-- Login Screen (Displayed when not authenticated) -->
        <div v-if="!isAuthenticated" class="min-h-screen flex items-center justify-center bg-slate-900">
            <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm">
                <h1 class="text-3xl font-bold text-center mb-6 text-slate-800">UppyMon Login</h1>
                <form @submit.prevent="login">
                    <div class="mb-4">
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Admin Password</label>
                        <input v-model="adminPassword" type="password" id="password" required class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button type="submit" :disabled="loading" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition duration-200 disabled:opacity-50">
                        <i v-if="loading" class="fa-solid fa-spinner fa-spin mr-2"></i>
                        <span v-else>Login</span>
                    </button>
                    <p v-if="loginError" class="text-red-500 text-sm mt-3 text-center">[[ loginError ]]</p>
                </form>
                <p class="text-center text-xs text-gray-400 mt-4">Default password is 'admin' on first run.</p>
            </div>
        </div>

        <!-- Main Dashboard (Only shows if isAuthenticated is true) -->
        <div v-else>
            <!-- Navbar -->
            <nav class="bg-slate-800 text-white p-4 shadow-lg">
                <div class="container mx-auto flex justify-between items-center">
                    <div class="text-xl font-bold flex items-center gap-2">
                        <i class="fa-solid fa-server"></i> UppyMon
                    </div>
                    <div class="flex space-x-3">
                        <button @click="logout" class="bg-red-700 hover:bg-red-600 px-4 py-2 rounded transition text-sm">
                            <i class="fa-solid fa-sign-out-alt"></i> Logout
                        </button>
                        <button @click="showSettings = true" class="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded transition text-sm">
                            <i class="fa-solid fa-gear"></i> Settings
                        </button>
                    </div>
                </div>
            </nav>

            <div class="container mx-auto p-4 max-w-5xl">
                
                <!-- Dashboard Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-white p-6 rounded-lg shadow border-l-4 border-green-500">
                        <div class="text-gray-500 text-sm">Servers UP</div>
                        <div class="text-3xl font-bold">[[ servers.filter(s => s.status === 'UP').length ]]</div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow border-l-4 border-red-500">
                        <div class="text-gray-500 text-sm">Servers DOWN</div>
                        <div class="text-3xl font-bold">[[ servers.filter(s => s.status === 'DOWN').length ]]</div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow border-l-4 border-blue-500">
                        <div class="text-gray-500 text-sm">Total Monitored</div>
                        <div class="text-3xl font-bold">[[ servers.length ]]</div>
                    </div>
                </div>

                <!-- Add Server Form -->
                <div class="bg-white p-4 rounded-lg shadow mb-6">
                    <form @submit.prevent="addServer" class="flex flex-col md:flex-row gap-4 items-end">
                        <div class="flex-1 w-full">
                            <label class="block text-xs font-bold text-gray-600 uppercase mb-1">Friendly Name</label>
                            <input v-model="newServer.name" type="text" placeholder="e.g. Production DB" class="w-full border rounded p-2 focus:outline-none focus:ring-2 focus:ring-blue-400" required>
                        </div>
                        <div class="flex-1 w-full">
                            <label class="block text-xs font-bold text-gray-600 uppercase mb-1">IP or Domain</label>
                            <input v-model="newServer.address" type="text" placeholder="e.g. 192.168.1.10" class="w-full border rounded p-2 focus:outline-none focus:ring-2 focus:ring-blue-400" required>
                        </div>
                        <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 font-bold">
                            <i class="fa-solid fa-plus"></i> Add
                        </button>
                    </form>
                </div>

                <!-- Server List -->
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-50 text-gray-600 uppercase text-xs">
                            <tr>
                                <th class="p-4">Name</th>
                                <th class="p-4">Address</th>
                                <th class="p-4">Last Check</th>
                                <th class="p-4">Status</th>
                                <th class="p-4 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-if="servers.length === 0">
                                <td colspan="5" class="p-8 text-center text-gray-400">No servers monitored yet.</td>
                            </tr>
                            <tr v-for="server in servers" :key="server.id" class="border-t hover:bg-gray-50 transition">
                                <td class="p-4 font-bold">[[ server.name ]]</td>
                                <td class="p-4 font-mono text-sm text-gray-600">[[ server.address ]]</td>
                                <td class="p-4 text-sm text-gray-500">[[ server.last_checked ]]</td>
                                <td class="p-4">
                                    <span :class="getStatusClass(server.status)" class="px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide">
                                        [[ server.status ]]
                                    </span>
                                </td>
                                <td class="p-4 text-right">
                                    <button @click="pingNow(server.id)" :disabled="pinging === server.id" class="text-blue-500 hover:text-blue-700 mr-3" title="Ping Now">
                                        <i :class="pinging === server.id ? 'fa-spin fa-solid fa-circle-notch' : 'fa-solid fa-rotate-right'"></i>
                                    </button>
                                    <button @click="confirmDelete(server)" class="text-red-500 hover:text-red-700" title="Remove">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Settings Modal -->
        <div v-if="showSettings" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4">
                <div class="bg-slate-800 text-white p-4 rounded-t-lg flex justify-between items-center">
                    <h3 class="font-bold">Global Configuration</h3>
                    <button @click="showSettings = false" class="hover:text-gray-300"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="p-6">
                    <!-- NEW ADMIN PASSWORD FIELD -->
                    <div class="mb-6 border-b pb-4">
                        <label class="block text-sm font-bold text-gray-700 mb-1">Admin Dashboard Password (Leave blank to keep current)</label>
                        <input v-model="config.admin_password" type="password" placeholder="**********" class="w-full border rounded p-2 focus:outline-none focus:ring-2 focus:ring-slate-400">
                        <p class="text-xs text-gray-500 mt-1">Changing this secures the dashboard and config settings.</p>
                    </div>
                    <!-- END NEW FIELD -->
                    
                    <div class="mb-4">
                        <label class="block text-sm font-bold text-gray-700 mb-1">Gmail Sender Address</label>
                        <input v-model="config.sender_email" type="email" class="w-full border rounded p-2">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-bold text-gray-700 mb-1">Gmail App Password</label>
                        <input v-model="config.sender_password" type="password" class="w-full border rounded p-2">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-bold text-gray-700 mb-1">Alert Receiver Email</label>
                        <input v-model="config.receiver_email" type="email" class="w-full border rounded p-2">
                    </div>
                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1">Interval (sec)</label>
                            <input v-model="config.check_interval" type="number" class="w-full border rounded p-2">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1">Retries</label>
                            <input v-model="config.retry_count" type="number" class="w-full border rounded p-2">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1">Timeout (sec)</label>
                            <input v-model="config.timeout_sec" type="number" class="w-full border rounded p-2">
                        </div>
                    </div>
                </div>
                <div class="p-4 bg-gray-50 rounded-b-lg text-right">
                    <button @click="saveConfig" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 font-bold">Save Settings</button>
                </div>
            </div>
        </div>
        
        <!-- Confirmation Modal -->
        <div v-if="serverToDelete" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-sm mx-4 p-6">
                <h3 class="text-xl font-bold mb-4 text-red-600">Confirm Deletion</h3>
                <p class="mb-6">Are you sure you want to stop monitoring **[[ serverToDelete.name ]]** ([[ serverToDelete.address ]])?</p>
                <div class="flex justify-end space-x-3">
                    <button @click="serverToDelete = null" class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400">Cancel</button>
                    <button @click="executeDelete" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 font-bold">Yes, Stop Monitoring</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp } = Vue;
        const AUTH_KEY = 'uppymon_auth';

        createApp({
            delimiters: ['[[', ']]'], // Tell Vue to use Square Brackets
            data() {
                return {
                    servers: [],
                    config: {},
                    newServer: { name: '', address: '' },
                    showSettings: false,
                    pinging: null,
                    timer: null,
                    
                    // --- Auth State ---
                    isAuthenticated: !!localStorage.getItem(AUTH_KEY), 
                    adminPassword: '',
                    loginError: '',
                    loading: false,

                    // --- Deletion Modal State ---
                    serverToDelete: null,
                }
            },
            methods: {
                // --- AUTH METHODS ---
                async login() {
                    this.loading = true;
                    this.loginError = '';
                    
                    try {
                        const res = await fetch('/api/auth', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ password: this.adminPassword })
                        });

                        const result = await res.json();
                        
                        if (res.ok && result.success) {
                            localStorage.setItem(AUTH_KEY, 'true'); // Simple token to persist login
                            this.isAuthenticated = true;
                            this.adminPassword = ''; // Clear sensitive input
                            this.initDataFetching(); // Start fetching data after successful login
                        } else {
                            this.loginError = result.message || 'Authentication failed.';
                            localStorage.removeItem(AUTH_KEY);
                        }
                    } catch (e) {
                        this.loginError = 'Error connecting to server.';
                        console.error(e);
                    } finally {
                        this.loading = false;
                    }
                },
                logout() {
                    localStorage.removeItem(AUTH_KEY);
                    this.isAuthenticated = false;
                    clearInterval(this.timer); // Stop polling
                    this.servers = [];
                    this.config = {};
                },
                // --- DATA METHODS ---
                initDataFetching() {
                    // Start fetching data only if authenticated
                    if (this.isAuthenticated) {
                        this.fetchData();
                        this.fetchConfig();
                        // Poll every 3 seconds for status updates
                        if (!this.timer) {
                            this.timer = setInterval(this.fetchData, 3000);
                        }
                    }
                },
                async fetchData() {
                    if (!this.isAuthenticated) return;
                    const res = await fetch('/api/status');
                    this.servers = await res.json();
                },
                async fetchConfig() {
                    if (!this.isAuthenticated) return;
                    const res = await fetch('/api/config');
                    this.config = await res.json();
                    // Clear password field in config after fetch so user sees the placeholder/mask
                    this.config.admin_password = ''; 
                },
                async addServer() {
                    await fetch('/api/server', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.newServer)
                    });
                    this.newServer.name = '';
                    this.newServer.address = '';
                    this.fetchData();
                },
                // Updated deletion logic using the custom modal
                confirmDelete(server) {
                    this.serverToDelete = server;
                },
                async executeDelete() {
                    const id = this.serverToDelete.id;
                    this.serverToDelete = null; // Close modal

                    try {
                        // *** CHANGE HERE: Using POST instead of DELETE to bypass network blocks ***
                        const response = await fetch(`/api/server/${id}`, { method: 'POST' }); 
                        
                        if (response.ok) {
                            console.log(`[UppyMon Frontend] Server ID ${id} deleted successfully.`);
                            this.fetchData(); // Refresh the list
                        } else {
                            console.error(`[UppyMon Frontend] Deletion failed. Server responded with status: ${response.status}`);
                        }
                    } catch (e) {
                        console.error('[UppyMon Frontend] Network error during deletion:', e);
                    }
                },
                async pingNow(id) {
                    this.pinging = id;
                    await fetch(`/api/trigger/${id}`, { method: 'POST' });
                    this.pinging = null;
                    this.fetchData();
                },
                async saveConfig() {
                    // Mask the admin password if it's left blank to avoid sending a null password
                    if (!this.config.admin_password) {
                        this.config.admin_password = '**********';
                    }

                    await fetch('/api/config', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.config)
                    });
                    this.showSettings = false;
                    
                    // If a password was provided (i.e., not the mask), we force a logout
                    if (this.config.admin_password && this.config.admin_password !== '**********') {
                        // NOTE: Replacing alert() with console log/visual feedback
                        console.log('Configuration saved. Logging out to enforce new password.');
                        // Since we cannot use alert(), we will just force the logout
                        this.logout(); 
                    } else {
                        // NOTE: Replacing alert() with console log/visual feedback
                        console.log('Configuration saved.');
                    }
                    this.fetchConfig(); // Reload config to update masked values
                },
                getStatusClass(status) {
                    if (status === 'UP') return 'status-up';
                    if (status === 'DOWN') return 'status-down';
                    return 'status-unknown';
                }
            },
            mounted() {
                this.initDataFetching();
            },
            beforeUnmount() {
                clearInterval(this.timer);
            }
        }).mount('#app');
    </script>
</body>
</html>